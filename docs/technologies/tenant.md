# 多租户系统架构说明文档

## 1. 系统概述

本系统采用多租户架构，支持数据隔离和租户管理。系统通过数据库Schema隔离和行级安全策略实现租户数据隔离，并提供完整的租户生命周期管理功能。

## 2. 核心概念

### 2.1 租户定义

租户是平台中的一个独立业务实体，可以是一个公司、部门或项目组。不同租户在平台上共享服务，但数据和配置相互隔离。

### 2.2 租户表结构

* 租户ID（id）

* 租户名称（name）
* 租户数据库标识（database）
* 租户数据架构标识（schema）
* 租户状态（status）
* 租户数据库连接字符串（connection_string）
* 租户组织机构代码（organization_code）
* 租户组织机构名称（organization_name）
* 租户分类（category）
* 租户描述（description）

## 3. 数据隔离策略

### 3.1 隔离模式

1. **Schema隔离**
   * 每个租户拥有独立的数据库Schema
   * 系统自动创建和管理租户Schema
   * 优点：数据完全隔离，安全性高
   * 缺点：Schema数量可能较多，管理复杂

2. **行级安全（默认策略）**
   * 所有租户共享同一个Schema
   * 通过行级安全策略实现数据隔离
   * 优点：管理简单，资源利用率高
   * 缺点：需要更严格的安全控制

### 3.2 组合策略

* 架构隔离 + 行级隔离

* 数据库隔离 + 行级隔离

## 4. 系统架构

### 4.1 租户管理模块

* **位置**: `apps/platform/src/modules/tenant/`

* **功能**:
  * 租户的创建、查询、更新、删除
  * 租户Schema管理
  * 租户信息维护
* **主要接口**:
  * POST `/tenants` - 创建新租户
  * GET `/tenants` - 获取所有租户
  * GET `/tenants/:id` - 获取指定租户
  * PUT `/tenants/:id` - 更新租户信息
  * DELETE `/tenants/:id` - 删除租户

### 4.2 租户上下文管理

* **位置**: `apps/platform/src/database/services/tenant-context.service.ts`

* **功能**:
  * 使用CLS（Continuation Local Storage）管理租户上下文
  * 存储和获取当前租户的Schema和ID
* **主要方法**:
  * `setTenantSchemaInCls(schema: string)` - 设置当前租户Schema
  * `getTenantSchemaFromCls()` - 获取当前租户Schema
  * `setTenantId(tenantId: string)` - 设置当前租户ID
  * `getTenantId()` - 获取当前租户ID

### 4.3 租户中间件

* **位置**: `apps/platform/src/database/middleware/tenant.middleware.ts`

* **功能**:
  * 从请求头中提取租户Schema
  * 验证租户Schema格式
  * 设置租户上下文
  * 排除特定路径的租户检查
* **主要逻辑**:
  * 检查请求路径是否在排除列表中
  * 验证`x-tenant-schema`请求头
  * 设置租户Schema到CLS中

### 4.4 数据库服务

* **位置**: `apps/platform/src/database/services/database.service.ts`

* **功能**:
  * 管理数据库连接
  * 实现租户隔离策略
  * 创建和管理租户Schema
  * 提供租户特定的数据库连接
* **主要特性**:
  * 支持两种租户隔离策略
  * 自动初始化数据库结构
  * 提供租户特定的数据库连接

## 5. 请求处理流程

1. 请求到达
2. 租户中间件处理：
   * 检查请求路径
   * 验证`x-tenant-schema`请求头
   * 设置租户上下文
3. 控制器处理业务逻辑
4. 数据库服务根据租户上下文提供相应的数据库连接
5. 执行数据库操作
6. 返回响应

## 6. 租户生命周期管理

### 6.1 租户创建

* 用户提交租户注册申请

* 系统管理员分配数据库和架构
* 生成数据库连接字符串
* 设置租户状态（默认：已禁用）

### 6.2 租户删除

* 软删除机制

* 数据归档处理
* 资源回收

### 6.3 租户修改

* 基本信息更新

* 状态变更
* 资源配置调整

### 6.4 租户查询

* 支持多种查询条件

* 分页和排序功能
* 租户详情展示

## 7. 安全与验证

* 租户Schema格式验证：`t_[a-zA-Z0-9_]+`
* 请求头验证：`x-tenant-schema`必须存在且格式正确
* 数据库操作前验证Schema是否存在
* 使用CLS确保租户上下文的一致性

## 8. 最佳实践

* 始终通过租户上下文服务获取当前租户信息
* 在数据库操作前验证租户上下文是否设置
* 使用事务确保数据一致性
* 定期清理未使用的租户Schema
* 监控数据库连接池的使用情况

## 9. 未来改进方向

* 实现租户配额管理
* 添加租户数据迁移功能
* 支持动态租户隔离策略切换
* 增强租户级别的监控和日志
* 实现租户级别的备份和恢复功能
